(function(){var impl,images;BOOMR=BOOMR||{};BOOMR.plugins=BOOMR.plugins||{};images=[{name:"image-0.png",size:11483,timeout:1400},{name:"image-1.png",size:40658,timeout:1200},{name:"image-2.png",size:164897,timeout:1300},{name:"image-3.png",size:381756,timeout:1500},{name:"image-4.png",size:1234664,timeout:1200},{name:"image-5.png",size:4509613,timeout:1200},{name:"image-6.png",size:9084559,timeout:1200}];images.end=images.length;images.start=0;images.l={name:"image-l.gif",size:35,timeout:1000};impl={base_url:'',timeout:15000,nruns:5,latency_runs:10,user_ip:'',cookie_exp:7*86400,cookie:'BA',results:[],latencies:[],latency:null,runs_left:0,aborted:false,complete:true,running:false,initialized:false,ncmp:function(a,b){return(a-b)},iqr:function(a){var l=a.length-1,q1,q3,fw,b=[],i;q1=(a[Math.floor(l*0.25)]+a[Math.ceil(l*0.25)])/2;q3=(a[Math.floor(l*0.75)]+a[Math.ceil(l*0.75)])/2;fw=(q3-q1)*1.5;l++;for(i=0;i<l&&a[i]<q3+fw;i++){if(a[i]>q1-fw){b.push(a[i])}}return b},calc_latency:function(){var i,n,sum=0,sumsq=0,amean,median,std_dev,std_err,lat_filtered;lat_filtered=this.iqr(this.latencies.sort(this.ncmp));n=lat_filtered.length;BOOMR.debug(lat_filtered,"bw");for(i=1;i<n;i++){sum+=lat_filtered[i];sumsq+=lat_filtered[i]*lat_filtered[i]}n--;amean=Math.round(sum/n);std_dev=Math.sqrt(sumsq/n-sum*sum/(n*n));std_err=(1.96*std_dev/Math.sqrt(n)).toFixed(2);std_dev=std_dev.toFixed(2);n=lat_filtered.length-1;median=Math.round((lat_filtered[Math.floor(n/2)]+lat_filtered[Math.ceil(n/2)])/2);return{mean:amean,median:median,stddev:std_dev,stderr:std_err}},calc_bw:function(){var i,j,n=0,r,bandwidths=[],bandwidths_corrected=[],sum=0,sumsq=0,sum_corrected=0,sumsq_corrected=0,amean,std_dev,std_err,median,amean_corrected,std_dev_corrected,std_err_corrected,median_corrected,nimgs,bw,bw_c,debug_info=[];for(i=0;i<this.nruns;i++){if(!this.results[i]||!this.results[i].r){continue}r=this.results[i].r;nimgs=0;for(j=r.length-1;j>=0&&nimgs<3;j--){if(!r[j]){break}if(r[j].t===null){continue}n++;nimgs++;bw=images[j].size*1000/r[j].t;bandwidths.push(bw);bw_c=images[j].size*1000/(r[j].t-this.latency.mean);bandwidths_corrected.push(bw_c);if(r[j].t<this.latency.mean){debug_info.push(j+"_"+r[j].t)}}}BOOMR.debug('got '+n+' readings',"bw");BOOMR.debug('bandwidths: '+bandwidths,"bw");BOOMR.debug('corrected: '+bandwidths_corrected,"bw");if(bandwidths.length>3){bandwidths=this.iqr(bandwidths.sort(this.ncmp));bandwidths_corrected=this.iqr(bandwidths_corrected.sort(this.ncmp))}else{bandwidths=bandwidths.sort(this.ncmp);bandwidths_corrected=bandwidths_corrected.sort(this.ncmp)}BOOMR.debug('after iqr: '+bandwidths,"bw");BOOMR.debug('corrected: '+bandwidths_corrected,"bw");n=Math.max(bandwidths.length,bandwidths_corrected.length);for(i=0;i<n;i++){if(i<bandwidths.length){sum+=bandwidths[i];sumsq+=Math.pow(bandwidths[i],2)}if(i<bandwidths_corrected.length){sum_corrected+=bandwidths_corrected[i];sumsq_corrected+=Math.pow(bandwidths_corrected[i],2)}}n=bandwidths.length;amean=Math.round(sum/n);std_dev=Math.sqrt(sumsq/n-Math.pow(sum/n,2));std_err=Math.round(1.96*std_dev/Math.sqrt(n));std_dev=Math.round(std_dev);n=bandwidths.length-1;median=Math.round((bandwidths[Math.floor(n/2)]+bandwidths[Math.ceil(n/2)])/2);n=bandwidths_corrected.length;amean_corrected=Math.round(sum_corrected/n);std_dev_corrected=Math.sqrt(sumsq_corrected/n-Math.pow(sum_corrected/n,2));std_err_corrected=(1.96*std_dev_corrected/Math.sqrt(n)).toFixed(2);std_dev_corrected=std_dev_corrected.toFixed(2);n=bandwidths_corrected.length-1;median_corrected=Math.round((bandwidths_corrected[Math.floor(n/2)]+bandwidths_corrected[Math.ceil(n/2)])/2);BOOMR.debug('amean: '+amean+', median: '+median,"bw");BOOMR.debug('corrected amean: '+amean_corrected+', '+'median: '+median_corrected,"bw");return{mean:amean,stddev:std_dev,stderr:std_err,median:median,mean_corrected:amean_corrected,stddev_corrected:std_dev_corrected,stderr_corrected:std_err_corrected,median_corrected:median_corrected,debug_info:debug_info}},defer:function(method){var that=this;return setTimeout(function(){method.call(that);that=null},10)},load_img:function(i,run,callback){var url=this.base_url+images[i].name+'?t='+(new Date().getTime())+Math.random(),timer=0,tstart=0,img=new Image(),that=this;img.onload=function(){img.onload=img.onerror=null;img=null;clearTimeout(timer);if(callback){callback.call(that,i,tstart,run,true)}that=callback=null};img.onerror=function(){img.onload=img.onerror=null;img=null;clearTimeout(timer);if(callback){callback.call(that,i,tstart,run,false)}that=callback=null};timer=setTimeout(function(){if(callback){callback.call(that,i,tstart,run,null)}},images[i].timeout+Math.min(400,this.latency?this.latency.mean:400));tstart=new Date().getTime();img.src=url},lat_loaded:function(i,tstart,run,success){if(run!==this.latency_runs+1){return}if(success!==null){var lat=new Date().getTime()-tstart;this.latencies.push(lat)}if(this.latency_runs===0){this.latency=this.calc_latency()}this.defer(this.iterate)},img_loaded:function(i,tstart,run,success){if(run!==this.runs_left+1){return}if(this.results[this.nruns-run].r[i]){return}if(success===null){this.results[this.nruns-run].r[i+1]={t:null,state:null,run:run};return}var result={start:tstart,end:new Date().getTime(),t:null,state:success,run:run};if(success){result.t=result.end-result.start}this.results[this.nruns-run].r[i]=result;if(i>=images.end-1||this.results[this.nruns-run].r[i+1]!==undefined){BOOMR.debug(this.results[this.nruns-run],"bw");if(run===this.nruns){images.start=i}this.defer(this.iterate)}else{this.load_img(i+1,run,this.img_loaded)}},finish:function(){if(!this.latency){this.latency=this.calc_latency()}var bw=this.calc_bw(),o={bw:bw.median_corrected,bw_err:parseFloat(bw.stderr_corrected,10),lat:this.latency.mean,lat_err:parseFloat(this.latency.stderr,10),bw_time:Math.round(new Date().getTime()/1000)};BOOMR.addVar(o);if(bw.debug_info.length>0){BOOMR.addVar("bw_debug",bw.debug_info.join(','))}if(!isNaN(o.bw)&&o.bw>0){BOOMR.utils.setCookie(this.cookie,{ba:Math.round(o.bw),be:o.bw_err,l:o.lat,le:o.lat_err,ip:this.user_ip,t:o.bw_time},(this.user_ip?this.cookie_exp:0))}this.complete=true;BOOMR.sendBeacon();this.running=false},iterate:function(){if(this.aborted){return false}if(!this.runs_left){this.finish()}else if(this.latency_runs){this.load_img('l',this.latency_runs--,this.lat_loaded)}else{this.results.push({r:[]});this.load_img(images.start,this.runs_left--,this.img_loaded)}},setVarsFromCookie:function(cookies){var ba=parseInt(cookies.ba,10),bw_e=parseFloat(cookies.be,10),lat=parseInt(cookies.l,10)||0,lat_e=parseFloat(cookies.le,10)||0,c_sn=cookies.ip.replace(/\.\d+$/,'0'),t=parseInt(cookies.t,10),p_sn=this.user_ip.replace(/\.\d+$/,'0'),t_now=Math.round((new Date().getTime())/1000);if(c_sn===p_sn&&t>=t_now-this.cookie_exp&&ba>0){this.complete=true;BOOMR.addVar({'bw':ba,'lat':lat,'bw_err':bw_e,'lat_err':lat_e});return true}return false}};BOOMR.plugins.BW={init:function(config){var cookies;if(impl.initialized){return this}BOOMR.utils.pluginConfig(impl,config,"BW",["base_url","timeout","nruns","cookie","cookie_exp"]);if(config&&config.user_ip){impl.user_ip=config.user_ip}if(!impl.base_url){return this}images.start=0;impl.runs_left=impl.nruns;impl.latency_runs=10;impl.results=[];impl.latencies=[];impl.latency=null;impl.complete=false;impl.aborted=false;BOOMR.removeVar('ba','ba_err','lat','lat_err');cookies=BOOMR.utils.getSubCookies(BOOMR.utils.getCookie(impl.cookie));if(!cookies||!cookies.ba||!impl.setVarsFromCookie(cookies)){BOOMR.subscribe("page_ready",this.run,null,this);BOOMR.subscribe("page_unload",this.skip,null,this)}impl.initialized=true;return this},run:function(){if(impl.running||impl.complete){return this}if(BOOMR.window.location.protocol==='https:'){BOOMR.info("HTTPS detected, skipping bandwidth test","bw");impl.complete=true;BOOMR.sendBeacon();return this}impl.running=true;setTimeout(this.abort,impl.timeout);impl.defer(impl.iterate);return this},abort:function(){impl.aborted=true;if(impl.running){impl.finish();}return this},skip:function(){if(!impl.complete){impl.complete=true;BOOMR.sendBeacon()}return this},is_complete:function(){return impl.complete}}}());
